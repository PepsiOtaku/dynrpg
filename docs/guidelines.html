<!-- HTML header for doxygen 1.10.0-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.12.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DynRPG: Rules and guidelines for plugin developers</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectlogo"><img alt="Logo" src="DynRPG_logo_webPepsiOtaku.png"  /></td>
              <td id="projectalign">
                <div id="projectname">DynRPG<span
                    id="projectnumber">&#160;v0.32 Unofficial</span>
                </div>
                <div id="projectbrief">Plugin SDK</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="topics.html"><span>Topics</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Rules and guidelines for plugin developers</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="rules"></a>
Rules</h1>
<p>The RPG Maker is written in Delphi (and I didn't have access to the source code of its classes, etc.), while my SDK uses C++. Thus, many things are not working the way you might expect.</p>
<p>There is a set of rules which you must follow under all circumstances when you are developing a DynRPG Plugin: </p><ul>
<li>
<b>Do not try to use members which are not documented.</b> They are either unknown or used internally and dangerous. (Of course, if you <em>know</em> what a member does, it's a different story.) </li>
<li>
<b>Do not instantiate <a class="el" href="namespace_r_p_g.html" title="The one and only namespace in which all DynRPG classes, variables and functions reside,...">RPG</a> classes.</b> Always use pointers to existing instances you get from DynRPG. It is especially dangerous to use these "home-made" objects with functions from the <a class="el" href="namespace_r_p_g.html" title="The one and only namespace in which all DynRPG classes, variables and functions reside,...">RPG</a> namespace. It might seem to work, but will most likely corrupt data. This will cause the game to behave strangely or suddenly crash some minutes later. <b>An exception to this rule are the <a class="el" href="class_r_p_g_1_1_music.html" title="Used for background music settings.">RPG::Music</a> and <a class="el" href="class_r_p_g_1_1_sound.html" title="Used for sound effect settings.">RPG::Sound</a> classes.</b> </li>
<li>
<b>Do not assign <a class="el" href="namespace_r_p_g.html" title="The one and only namespace in which all DynRPG classes, variables and functions reside,...">RPG</a> objects.</b> The result is mostly undefined. An exception are pointers to <a class="el" href="class_r_p_g_1_1_image.html" title="Used for image buffers (8 bit)">RPG::Image</a> objects, as long as you don't forget to destroy the old object using <a class="el" href="class_r_p_g_1_1_image.html#a77db167e3c62337c0725da58b9822225" title="Destroys an image.">RPG::Image::destroy</a> (unless you want to use it before). </li>
<li>
<b>Do not randomly return <code>false</code> from a callback function.</b> This will "lock out" all plugins which are called after yours. Only return <code>false</code> if you really want this behavior. </li>
<li>
<b>Never change the <code>vTable</code> member of a class.</b> This will make the game crash sooner or later (probably sooner). </li>
<li>
<b>Never assign a <code>char *</code> to an <a class="el" href="class_r_p_g_1_1_d_string.html" title="Helper class representing a Delphi string.">RPG::DString</a> pointer.</b> It will appear to work, but it will cause the game to crash with an "Invalid pointer operation" error when the RPG Maker tries to free the string. Also, do not store <a class="el" href="class_r_p_g_1_1_d_string_ptr.html" title="Mighty wrapper class for DString pointers, the string class for RPG Maker strings.">RPG::DStringPtr</a> objects or <a class="el" href="class_r_p_g_1_1_d_string.html" title="Helper class representing a Delphi string.">RPG::DString</a> pointers inside your plugin, but copy their content to a <code>std::string</code> instead, since <a class="el" href="class_r_p_g_1_1_d_string.html" title="Helper class representing a Delphi string.">RPG::DString</a> objects may suddenly vanish. </li>
<li>
<b>Do not change the current directory.</b> </li>
<li>
<b>Do not do stuff every frame which takes longer than one millisecond.</b> This is alredy the very maximum. The less time you use, the better. If you need to do something which takes longer, do it in another thread. An exception are things which happen only rarely, like when a game is loaded or saved, or once when a battle starts, etc. If something should intentionally take longer than one frame, you could use the <a class="el" href="class_r_p_g_1_1_screen.html#a51af181959998af86eb234a0a9fd6fac">RPG::Screen::update</a> or <a class="el" href="namespace_r_p_g.html#a765f07f75f93a473e60e285c46fd5686" title="Updates the battle, including actions, ATB, animations, etc.">RPG::updateBattle</a> function, respectively.</li>
</ul>
<h1><a class="anchor" id="guidelines_sec"></a>
Guidelines</h1>
<p>There is also a set of guidelines which you are strongly advised to follow, but there might be cases in which there is a better solution.</p>
<h2><a class="anchor" id="event_comments"></a>
Event comments</h2>
<p>Comments in event scripts are a great way to let events scripts invoke functions of your plugin. Please follow the following guidelines: </p><ul>
<li>
Use the following pattern for "special comments": <div class="fragment"><div class="line">@command parameter1, parameter2, parameter3, ...</div>
</div><!-- fragment -->  </li>
<li>
New-line characters should be generally ignored. </li>
<li>
The comment has to start with an <code>@</code> sign, immediately followed by the command name. </li>
<li>
The command name is case-insensitive. </li>
<li>
There should be three possible types of parameters: <ul>
<li>
<b>Number:</b> A simple number. Can also use the decimal point and the scientific notation (e.g. <code>5.5e+6</code> for 5.5 million). </li>
<li>
<b>String:</b> A simple string. Must be put between doublequotes. To use a doublequote in a string, it is written twice (e.g. <code>He said ""hello"" and smiled</code>) </li>
<li>
<b>Token:</b> Some identifier. Tokens are not put between quotes, and they may not contain spaces (spaces are removed). Tokens are case-insensitive. They may be used for keywords.</li>
</ul>
There are special tokens for referencing variables and actor names: <ul>
<li>
<b>Variables:</b> To reference a variable, the user should be able to write a <code>V</code> character prior to the variable ID. This should also work with multiple levels of dereferencing. </li>
<li>
<b>Actor names:</b> To reference an actor's name, the user should be able to write a <code>N</code> character prior the the actor ID. This should also work together with <code>V</code>.</li>
</ul>
</li>
<li>
The command name and tokens should be case-insensitive. </li>
<li>
Always return <code>false</code> from <a class="el" href="group__callbacks.html#gae23e92c109881bcec43cfb2838f3aead">onComment</a> when you found a known command, regardless whether the parameters were valid or not. </li>
<li>
Always return <code>true</code> from <a class="el" href="group__callbacks.html#gae23e92c109881bcec43cfb2838f3aead">onComment</a> when you didn't find a known command, even though you may have found an <code>@</code> sign at the beginning of the comment.</li>
</ul>
<p><b>Use the <code>parsedData</code> parameter of your <a class="el" href="group__callbacks.html#gae23e92c109881bcec43cfb2838f3aead">onComment</a> handler to get the comment data in an already nicely parsed form!</b> </p><dl class="section note"><dt>Note</dt><dd>The maximum number of parameters is 100. The maximum number of characters per parameter (or command name) is 200. You have to parse the comment yourself if you need more.</dd></dl>
<p>Example for a "special" comment: </p><div class="fragment"><div class="line">@FooBar 123, <span class="stringliteral">&quot;abc&quot;</span>, V55, VV66, N7, NV8, Nothing</div>
</div><!-- fragment --><p> The command name is <code>foobar</code>.<br  />
 The first parameter is numerical.<br  />
 The second parameter is a string.<br  />
 The third parameter is a numerical value read from variable #55.<br  />
 The fourth parameter is a numerical value read from the variable whose ID is stored in variable #66.<br  />
 The fifth parameter is a string, read from the name of actor #7.<br  />
 The sixth parameter is a string, read from the name of the actor whose ID is stored in variable #8.<br  />
 The seventh parameter is a token named <code>nothing</code>.</p>
<p>You might advise users to download <a href="http://cherrytree.at/ultimate">RPG Maker 2009 Ultimate</a> if they need to enter comments longer than 4 lines.</p>
<h2><a class="anchor" id="configuration"></a>
Configuration</h2>
<p>Many plugins need some kind of configuration. An important rule is: <b>Make as many things configurable as possible.</b></p>
<p>If possible, store configuration in a <code>DynRPG.ini</code> file. Also, you should use your plugin's name which you get as parameter to the <a class="el" href="group__callbacks.html#ga8a8edd989b9169752c0239bbadb3f9fd">onStartup</a> function as section name. If you need several sections, you can append an underscore and an additional identifier to the name and use it as section name. This will prevent conflicts with other plugins while still combining all relevant configuration of a game in one file.</p>
<p>You may use the <a class="el" href="namespace_r_p_g.html#a384f30c4af9e6144612a638236ae0a79" title="Returns a std::map containing configuration from an INI file.">RPG::loadConfiguration</a> function as a convenient way to load configuration data to a <code>std::map&lt;std::string, std::string&gt;</code> in the <a class="el" href="group__callbacks.html#ga8a8edd989b9169752c0239bbadb3f9fd">onStartup</a> function.</p>
<p>If you need more or more complex configuration, like XML data, use a filename containing your plugin's name.</p>
<h2><a class="anchor" id="ingame_data"></a>
In-game data</h2>
<p>Your plugin may also use data which is changed in-game and needs to be preserved. Savestate-independent data (like a highscore) should be stored in the <code>DynRPG.ini</code> file together with configuration (use the WinAPI function <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms725501(v=vs.85).aspx">WritePrivateProfileString</a>).</p>
<p>Savestate-related data (data which should be saved when the user saves the game and loaded when the use loads a saved game) should be saved using the function passed as <code>savePluginData</code> parameter to the <a class="el" href="group__callbacks.html#gaec141f78a287175b08e49f2e6b09e857">onSaveGame</a> function. When the user loads the savestate again, you will get the same data back, in the parameters to the <a class="el" href="group__callbacks.html#gaf286710eea5356161c7790be7ca3e943">onLoadGame</a> function. Internally, this data is saved in a file called <code>SaveXX.dyn</code> where <code>XX</code> is the savestate ID.</p>
<p>An example usage of savestate-related plugin data is shown here: </p><div class="fragment"><div class="line"><span class="comment">// Plugin-related data</span></div>
<div class="line"><span class="keywordtype">int</span> score;</div>
<div class="line"><span class="keywordtype">int</span> level;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="group__callbacks.html#gaf286710eea5356161c7790be7ca3e943">onLoadGame</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> length) {</div>
<div class="line">    <span class="keywordflow">if</span>(length == <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * 2) { <span class="comment">// make sure it is valid data</span></div>
<div class="line">        <span class="keywordtype">int</span> *dataArray = (<span class="keywordtype">int</span> *)data;</div>
<div class="line">        score = dataArray[0];</div>
<div class="line">        level = dataArray[1];</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="group__callbacks.html#gaec141f78a287175b08e49f2e6b09e857">onSaveGame</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keywordtype">void</span> __cdecl (*savePluginData)(<span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> length)) {</div>
<div class="line">    <span class="keywordtype">int</span>[2] dataArray;</div>
<div class="line">    dataArray[0] = score;</div>
<div class="line">    dataArray[1] = level;</div>
<div class="line">    savePluginData((<span class="keywordtype">char</span> *)dataArray, <span class="keyword">sizeof</span>(dataArray));</div>
<div class="line">}</div>
<div class="ttc" id="agroup__callbacks_html_gaec141f78a287175b08e49f2e6b09e857"><div class="ttname"><a href="group__callbacks.html#gaec141f78a287175b08e49f2e6b09e857">onSaveGame</a></div><div class="ttdeci">void onSaveGame(int id, void(*savePluginData)(char *data, int length))</div><div class="ttdoc">Called before the player saves a game.</div></div>
<div class="ttc" id="agroup__callbacks_html_gaf286710eea5356161c7790be7ca3e943"><div class="ttname"><a href="group__callbacks.html#gaf286710eea5356161c7790be7ca3e943">onLoadGame</a></div><div class="ttdeci">void onLoadGame(int id, char *data, int length)</div><div class="ttdoc">Called before the player loads a game from a savestate.</div></div>
</div><!-- fragment --><p> (Of course, the same result could have been achieved by saving <code>score</code> and <code>level</code> in in-game variables which are automatically saved.)</p>
<h2><a class="anchor" id="optimization"></a>
Optimization</h2>
<p><b>Time is a very important factor.</b> Especially with many plugins, it is important to use as little time as possible in your callback handlers, otherwise the game will eventually start lagging. Thus, try to optimize your code where you can. If possible, always test your plugin with several other plugins in a "real-life situation" to see whether your plugin slows the game down too much. Remember that most of your code will be executed a minimum of 60 times per second (many parts more often than that, for example <a class="el" href="group__callbacks.html#ga862305d7d40b374d0001a7aa47d7402f">onCheckEventVisibility</a> will be called 900 times per second if there are 150 events on the map).</p>
<p>Here is a bit of advice how to optimize your plugin code: </p><ul>
<li>
<b>Do not allocate and deallocate memory or objects over and over again.</b> Try to use static variables wherever possible. </li>
<li>
Try to use functions in the <a class="el" href="class_r_p_g_1_1_image.html" title="Used for image buffers (8 bit)">RPG::Image</a> and <a class="el" href="class_r_p_g_1_1_canvas.html" title="Image buffer with 16 bit color depth, used as canvas for multiple 8-bit images">RPG::Canvas</a> classes as little as possible. The slowest functions are <a class="el" href="class_r_p_g_1_1_image.html#a21ba9ccb9b4f660004b725106554438a" title="Broken as of v 0.20. Use RPG::Image::drawString instead as it is using the same rm2k3 function,...">RPG::Image::drawText</a> and <a class="el" href="class_r_p_g_1_1_canvas.html#a37bb56fb355bafaf1dcf93c0c0ab946c" title="Draws an RPG::Image or a part of it onto the canvas.">RPG::Canvas::draw</a>. </li>
<li>
Try to cache text in an <a class="el" href="class_r_p_g_1_1_image.html" title="Used for image buffers (8 bit)">RPG::Image</a> if possible, only update it if necessary. </li>
<li>
Try to cache as much with the same palette as possible on the same <a class="el" href="class_r_p_g_1_1_image.html" title="Used for image buffers (8 bit)">RPG::Image</a> so that you don't have to call <a class="el" href="class_r_p_g_1_1_canvas.html#a37bb56fb355bafaf1dcf93c0c0ab946c" title="Draws an RPG::Image or a part of it onto the canvas.">RPG::Canvas::draw</a> too often. </li>
<li>
If possible, don't use a transparent color in <a class="el" href="class_r_p_g_1_1_image.html#ab4576b2fdb7dc8eb26a752d1ba18e551" title="Copies pixels into the image.">RPG::Image::draw</a> (set <code>maskColor</code> to <a class="el" href="namespace_r_p_g.html#a64e5271b05e1f6d4b12a3cd777f47b4ca2ff71939cb156a114857b37851058504" title="Used for RPG::Image::draw if no transparent color should be used.">RPG::MASK_NONE</a>). The same rule applies for <a class="el" href="class_r_p_g_1_1_canvas.html#a37bb56fb355bafaf1dcf93c0c0ab946c" title="Draws an RPG::Image or a part of it onto the canvas.">RPG::Canvas::draw</a>, see also <a class="el" href="class_r_p_g_1_1_image.html#a745122005d521e88f98f1c204bf954d3" title="If true, color 0 will be used as transparent color.">RPG::Image::useMaskColor</a>. </li>
<li>
Try to skip frames if possible. This means: Try to update some things only every 2 or 3 frames if possible. </li>
<li>
If you are "WinAPI-literate", you can use the <a class="el" href="class_r_p_g_1_1_canvas.html#af3a3ee88dc1156944caad0283d61dda2" title="Underlying 16-bit bitmap.">RPG::Canvas::bitmap</a> member and the <a class="el" href="class_r_p_g_1_1_d_bitmap.html#ac2858762fe9bb4a64de999ead16c077e" title="Returns the HBITMAP.">RPG::DBitmap::getHBITMAP</a> and <a class="el" href="class_r_p_g_1_1_d_bitmap.html#af424b90a2c30746df0be9e1a1fdc75f3" title="Returns the HDC.">RPG::DBitmap::getHDC</a> functions to get handles to the corresponding GDI objects and manipulate them directly. </li>
<li>
If you need to calculate something more complex (like a 3D image, etc.) you better do this in a new thread, cache its graphics and draw them to the screen only after calculation was finished, without letting the main thread wait.</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.10.0-->
<!-- start footer part -->
<hr class="footer" />
<address class="footer"><small>
    Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg"
        width="104" height="31" alt="doxygen" /></a> 1.12.0
  </small></address>
</body>
</html>
